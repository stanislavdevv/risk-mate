// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model RiskResult {
  id          String @id @default(cuid())
  shop        String
  orderGid    String
  orderName   String
  score       Int
  riskLevel   String
  reasonsJson String

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  lastEventId String?
  lastEvent   RiskEvent? @relation("RiskResultLastEvent", fields: [lastEventId], references: [id])

  // trust features
  lastTopic   String?
  lastEventAt DateTime?
  eventCount  Int       @default(0)
  payloadHash String?

  // ✅ why we skipped / what happened
  lastDecision String? // "APPLIED" | "SKIPPED"
  skipReason   String? // "UNCHANGED" | "NO_RULES" | etc.

  // ✅ new trust feature
  lastRiskChangeAt DateTime?

  @@unique([shop, orderGid])
  @@index([shop, createdAt])
  @@index([shop, lastEventAt])
  @@index([shop, lastRiskChangeAt])
}

model RiskRule {
  id   String @id @default(cuid())
  shop String

  type     String // ORDER_VALUE | FIRST_TIME | COUNTRY_MISMATCH | HIGH_QTY
  operator String // > | = | != | >=
  value    String // "300", "true", "DE"
  points   Int

  action  String? // TAG:high_risk | HOLD | REVIEW
  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
}

enum RiskEventSource {
  ORDERS_CREATE
  ORDERS_UPDATED
  ORDERS_PAID
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum RiskDecision {
  ALLOW
  REVIEW
  HOLD
}

model RiskEvent {
  id String @id @default(cuid())

  // identity
  shop        String
  orderGid    String
  orderNumber String?
  rulesVersion String @default("unknown")

  // webhook meta
  source    RiskEventSource
  topic     String // e.g. "orders/create"
  webhookId String? // if you can extract Shopify webhook id/header
  createdAt DateTime        @default(now())

  // core data
  snapshot  Json // normalized "safe" order snapshot (no protected customer data)
  evaluated Json // [{ ruleId, ruleKey, matched, weight, details? }]
  reasons   Json // explainability v2: { summary, factors:[...] }

  // computed outcome
  riskScore Int
  riskLevel RiskLevel
  decision  RiskDecision

  asLastEventFor RiskResult[] @relation("RiskResultLastEvent")

  @@index([shop, orderGid])
  @@index([shop, createdAt])
  @@index([shop, orderGid, createdAt])
}
